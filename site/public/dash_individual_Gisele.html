<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MarketSafe | Dashboard</title>
    <link rel="stylesheet" href="./css/dash_gisele.css" />
    <link rel="icon" href="css/icon.png" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-wordcloud"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>

<body onload="atualizarTabela()">
    <div class="container">
        <div class="menu">
            <div class="div_logo">
                <div class="logo">
                    <img src="assets/img/Logo Self 2.png" alt="">
                </div>
                <div class="MKTS">
                    <h1>MKTS</h1>
                </div>
            </div>
            <div class="select_dash">
                <h2>Dashboards</h2>
            </div>
            <div class="regiao-select">
                <div class="analista">
                    <h3>Gerente</h3>
                </div>
                <div class="monitoramento">
                    <p>Previsão</p> <i class='bx bx-show'></i>
                </div>
                <div class="monitoramento">
                    <p>Histórico</p> <i class='bx bx-file-blank'></i>
                </div>
                <div class="monitoramento">
                    <p>BenchMark</p> <i class="fa-solid fa-scale-balanced"></i>
                </div>
            </div>
            <div class="linha">
            </div>
            <div class="perfil">
                <div class="foto_perfil">
                    <img src="./assets/img/foto-gerente.jpg" alt="">
                </div>
                <div class="nome_perfil">
                    <div class="nome">
                        <h2>Vitor</h2>
                    </div>
                    <hr>
                    <div class="cargo">
                        <p>Gerente</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashes-historico">
            <div class="dashboard-title">Histórico de Monitoramento</div>
            <div class="engloba-indicador">
                <div class="status-container">
                    <div class="fundo-status">
                        <div class="alerta-status-title">Status de Performance da Filial</div>
                        <div class="engloba-status">
                            <div class="area-fora">
                                <div class="status-box critico">
                                    <div class="face front">Filial 1<br>
                                        Filial 2
                                    </div>
                                    <div class="face back back1">
                                        <div class="status-label">Crítico</div>
                                        <div class="status-numero">2</div>
                                    </div>
                                </div>
                            </div>
                            <div class="area-fora">
                                <div class="status-box atencao">
                                    <div class="face front ">Filial 3 </div>
                                    <div class="face back back2">
                                        <div class="status-label">Atenção</div>
                                        <div class="status-numero">1</div>
                                    </div>
                                </div>
                            </div>
                            <div class="area-fora">
                                <div class="status-box normal">
                                    <div class="face front ">Filial 4<br>
                                        Filial 5
                                    </div>
                                    <div class="face back back3">
                                        <div class="status-label">Normal</div>
                                        <div class="status-numero">2</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ranking">
                    <div class="ranking-title">3 Promoções com mais Alertas</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Posição</th>
                                <th>Promoção</th>
                                <th>Alertas</th>
                            </tr>
                        </thead>

                        <tbody id="corpoTabela">

                        </tbody>
                        <!-- <tr>
                            <td>1</td>
                            <td>Carnes</td>
                            <td>20</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Bebidas</td>
                            <td>13</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Frutas</td>
                            <td>9</td>
                        </tr> -->
                    </table>
                </div>
            </div>
            <div class="plano-fundo">
                <div class="filtros">
                    <div class="selecoes">
                        <div class="fTote">
                            <h2 class="h2-title">Filial</h2>
                            <div class="fSelect">
                                <select id="filial">
                                    <option value="">Escolha uma filial</option>
                                    <option value="1">Filial 1</option>
                                    <option value="2">Filial 2</option>
                                    <option value="3">Filial 3</option>
                                    <option value="4">Filial 4</option>
                                    <option value="5">Filial 5</option>
                                </select>
                            </div>
                        </div>
                        <div class="fTote">
                            <h2 class="h2-title">Mês</h2>
                            <div class="fSelect">
                                <input type="month" name="" id="">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="engloba-grafico">
                    <div class="fundo-grafico">
                        <div class="fundo-grafico-title">Alertas Mensais por Dia da Semana</div>
                        <div class="chart-area">
                            <canvas id="barChart" width="550px" height="275px"></canvas>
                        </div>
                    </div>
                    <div class="fundo-grafico">
                        <div class="fundo-grafico-title">Taxa de Alerta por Componentes</div>
                        <div class="grafico-pizza">
                            <canvas id="pieChart" width="350px" height="225px"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
</body>

</html>

<script>

function adicionarPromocao(tabela, posicao, promocao, quantidadeDeAlertas) {
    var linha = document.createElement('tr');
    var lugar = document.createElement('td');
    var desconto = document.createElement('td');
    var qtdAlertas = document.createElement('td');

    lugar.innerHTML = `${posicao}`;
    desconto.textContent = promocao;
    qtdAlertas.textContent = quantidadeDeAlertas;

    linha.appendChild(lugar);
    linha.appendChild(desconto);
    linha.appendChild(qtdAlertas);
    tabela.appendChild(linha);
}

function atualizarTabela() {
    fetch('/ranking/classificacao')
        .then(response => response.json())
        .then(data => {
            var tabela = document.getElementById("corpoTabela");

            tabela.innerHTML = '';

            
            for (var i = 0; i < Math.min(3, data.length); i++) {
                var item = data[i];
                var nomePromocao = item.promocao;
                var qtdAlertas = item.qtd_alertas;

                adicionarPromocao(tabela, i + 1, nomePromocao, qtdAlertas);
            }
        })
        .catch(error => console.error('Erro ao buscar promoção:', error));
}


    function MudandoValoresDash() {
        var selectOpcao = document.getElementById('filial').value;

        if (selectOpcao) {
            pieChart.options.plugins.datalabels.display = true;
        } else {
            pieChart.options.plugins.datalabels.display = false;
        }

        if (selectOpcao === '1') {
            barChart.data.datasets[0].data = [45, 68, 32, 34, 45, 60, 56];
            pieChart.data.datasets[0].data = [70, 30];
        } else if (selectOpcao === '2') {
            barChart.data.datasets[0].data = [52, 35, 12, 34, 45, 60, 56];
            pieChart.data.datasets[0].data = [65, 35];
        } else if (selectOpcao === '3') {
            barChart.data.datasets[0].data = [15, 28, 42, 34, 45, 60, 56];
            pieChart.data.datasets[0].data = [60, 40];
        } else if (selectOpcao === '4') {
            barChart.data.datasets[0].data = [2, 8, 17, 34, 45, 32, 21];
            pieChart.data.datasets[0].data = [75, 25];
        } else if (selectOpcao === '5') {
            barChart.data.datasets[0].data = [15, 28, 42, 34, 12, 21, 61];
            pieChart.data.datasets[0].data = [35, 65];
        }

        barChart.update();
        pieChart.update();
    }

    const labels = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
    const data = {
        labels: labels,
        datasets: [{
            axis: 'y',
            label: 'Quantidade de Alerta ',
            data: [0, 0, 0, 0, 0, 0, 0],
            fill: false,
            backgroundColor: [
                'rgba(255, 159, 64, 1)'
            ],
            borderColor: [
                'rgb(255, 159, 64)'
            ],
            borderWidth: 1
        }]
    };

    const config = {
        type: 'bar',
        data: data,
        options: {
            indexAxis: 'x',
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.90)'
                    },
                }, y: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.90)'
                    },
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        }
    };

    const barChart = new Chart(
        document.getElementById('barChart'),
        config
    );

    const pieData = {
        labels: ['Processador', 'Memória Ram'],
        datasets: [{
            data: [0, 0],
            backgroundColor: [
                'rgb(155, 17, 30)',
                'rgb(5, 79, 119)'
            ],
            hoverOffset: 4
        }]
    };

    const pieConfig = {
        type: 'pie',
        data: pieData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            size: 15
                        },
                        color: 'rgba(255, 255, 255, 0.90)'
                    }
                },

                datalabels: {
                    display: false,
                    formatter: (value, context) => {
                        const total = context.chart._metasets[context.datasetIndex].total;
                        const percentage = ((value / total) * 100).toFixed(2);
                        return `${percentage}%\n${value}`;
                    },
                    color: "#000",
                    font: {
                        size: 18
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    };



    const pieChart = new Chart(
        document.getElementById('pieChart'),
        pieConfig
    );


    document.getElementById('filial').addEventListener('change', MudandoValoresDash);

</script>