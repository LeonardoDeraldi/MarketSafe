<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MarketSafe | Dashboard</title>
    <link rel="stylesheet" href="css/dash_individual_Isaque.css" />
    <link rel="icon" href="css/icon.png" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://kit.fontawesome.com/0b71632824.js" crossorigin="anonymous"></script>


</head>

<body>
    <div class="container">
        <div class="menu">
            <div class="div_logo">
                <img src="assets/img/Logo Self 2.png" alt="">
                <div class="MKTS">
                    <h1>MKTS</h1>
                </div>
            </div>
            <div class="select_dash">
                <h2>Dashboards</h2>
            </div>
            <div class="regiao-select">
                <div class="analista">
                    <h3>Analista</h3>
                </div>
                <div class="monitoramento">
                    <p>Monitoramento</p> <i class='bx bx-show'></i>
                </div>
                <div class="monitoramento">
                    <p>Histórico</p> <i class='bx bx-file-blank'></i>
                </div>
                <div class="monitoramento">
                    <p>BenchMark</p> <i class="fa-solid fa-scale-balanced"></i>
                </div>
            </div>
            <div class="linha">
            </div>
            <div class="perfil">
                <div class="foto_perfil">
                    <img src="css/foto-anilista.jpg" alt="">
                </div>
                <div class="nome_perfil">
                    <div class="nome">
                        <h2>Fred</h2>
                    </div>
                    <hr>
                    <div class="cargo">
                        <p>Analista</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashes">
            <div class="botoes_superiores">
                <div class="botao_voltar">
                    <a href="dash_individual_Isaque_Principal.html"><i class="fa-solid fa-chevron-left"></i></a>
                </div>
                <div class="icon" onclick="acionarAlertasENotificacao()">
                    <i class="fa-solid fa-triangle-exclamation"><span id="QtdAlertas"></span></i>
                </div>
            </div>
            <div class="Span_Titulo">
                <span>Situação do Totem 2</span>
            </div>
            <div class="bloco_monitoramento">
                <div class="bloco1">
                    <span class="span_bloco_monitoramento">Status</span>
                    <div id="status" class="status">
                        Alerta
                    </div>
                </div>
                <div class="bloco2">
                    <span class="span_bloco_monitoramento">RAM</span>
                    <div id="ram" class="ram">
                        85%
                    </div>
                </div>
                <div class="bloco3">
                    <span class="span_bloco_monitoramento">Atividade</span>
                    <div id="tempo_ativo" class="tempo_ativo">
                        03:27:30
                    </div>
                </div>
                <div class="bloco4">
                    <span class="span_bloco_monitoramento">Recomendado</span>
                    <div id="recomendado" class="recomendado">
                        Reiniciar
                    </div>
                </div>

            </div>
            <div id="chart-timeline" style="height: 350px;"></div>

            <div class="engloba_rank_qtdTotens">

            </div>
            <!-- <button class="button" onclick="notificacao(ErroMsg)">Teste Notificar</button> -->

            <div class="notifi-box" id="box">
                <h2>Alertas<span id="QtdAlertas2"></span></h2> <!--textinho dentro do alerta-->

            </div>
            <div id="notify_box"></div>

        </div>

    </div>

</body>

</html>

<script>




    // Configurações do gráfico ApexCharts
    var options = {
        series: [{
            name: 'Consumo',
            data: dataSeries,
            color: "#FF7000"
        }],
        chart: {
            id: 'area-datetime',
            type: 'area',
            width: '95%',
            height: 345,
            animations: {
                enabled: true,
                speed: 800,
                animateGradually: {
                    enabled: true,
                    delay: 5050
                },
                dynamicAnimation:{
                    enabled: true,
                    speed: 350
                }
            },
            toolbar: {
                show: false
            }
        },
        dataLabels: {
            enabled: false
        },
        tooltip: {
            theme: 'dark',
            x: {
                show: false
            }
        },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.9,
                stops: [0, 100]
            }
        },
        legend: {
            show: true,
        },
        xaxis: {
            title: {
                text: 'Captura dos Ultimos 60 segundos',
                style:{
                    color: '#ffff',
                    fontSize: '15px',
                    fontFamily: 'Abel',
                },
                offsetX: -330
            },
            type: 'numeric',
            tickAmount: 10,
            labels: {
                show: false
            }
        },
        yaxis: {
        min: 0,
        max: 100,
        labels: {
          formatter: function(value) {
            if (value === 100) return 'Max - 100%';
            if (value === 0) return 'Min - 0%';
            return value + '%';
          },
          style: {
            colors: '#ffffff',
            fontSize: '12px',
            fontFamily: 'Abel',
            marginLeft: '15px'
          },
          offsetX: +5
        }
      },
      title: {
          text: '% em Uso',
          style: {
            color: '#ffffff',
            fontSize: '20px',
            fontFamily: 'Abel',
          },
          offsetX: +78
        }
    };

    var chart = new ApexCharts(document.querySelector("#chart-timeline"), options);
    chart.render();


    //-------------- Alertas -----------------//

    let notify_box = document.getElementById('notify_box');
    let ErroMsg = '<i class="fa-solid fa-circle-exclamation"></i> Erro no Totem';

    var QtdNotify = 0;
    var QtdNotify2 = 0;
    var contador = 0;

    var box = document.getElementById('box');
    var down = false;

    function Alertas() {
        if (down) {
            box.style.height = '0px';
            box.style.opacity = 0;
            box.classList.remove('open'); 
            down = false;
        } else {
            box.style.height = '510px';
            box.style.opacity = 1;
            setTimeout(function () {
                box.classList.add('open'); 
            }, 300);
            down = true;
        }

    }

    // --------- CPU do Totem 2 ------------//

    var dataSeries = [];
    var dataSeries2 = [];
    var tempo = 0;

    function Atualizar_ValorT2() {
    fetch("/monitoramento/AtualizarValorT2", 
    { method: "POST" })
        .then(response => {
            //console.log(response)
            //response.text().then(text => console.log(text))
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Erro ao buscar os dados do servidor.");
            }
        })
        .then(resultado => {
            if (resultado.length > 0) {
                // console.log(resultado)
                const valorCpu = parseFloat(resultado[0].CpuT2); 
                dataSeries.push({ x: tempo, y: valorCpu });
                tempo += 1; 
                // console.log(dataSeries); 

                if (dataSeries.length > 35) {
                    dataSeries.shift();
                }   

                chart.updateSeries([
                    { name: 'T2', data: dataSeries }
                ]);

            }
        })
        .catch(error => {
            console.error("Erro na requisição:", error);
        });
}
setInterval(Atualizar_ValorT2, 1000);

// --------- Ram do Totem 2 ------------//

function Atualizar_ValorRamT2() {
    fetch("/monitoramento/AtualizarValorRamT2", 
    { method: "POST" })
        .then(response => {
            //console.log(response)
            //response.text().then(text => console.log(text))
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Erro ao buscar os dados do servidor.");
            }
        })
        .then(resultado => {
            if (resultado.length > 0) {
                // console.log(resultado)
                const valorRam = parseFloat(resultado[0].RamT2); 
                dataSeries2.push({ x: tempo, y: valorRam });
                tempo += 1; 
                // console.log(dataSeries6); 

                if (dataSeries2.length > 10) {
                    dataSeries2.shift();
                }

            }

        })
        .catch(error => {
            console.error("Erro na requisição:", error);
        });
}
setInterval(Atualizar_ValorRamT2, 1000);

    //-------------- Vetores -----------------//

    var VetorRamT2 = [];

    function Atualizar_Vetores() {
        if (dataSeries2.length > 0) {
            const ultimoValorRamT2 = Math.round(dataSeries2[dataSeries2.length - 1].y);
            VetorRamT2 = [ultimoValorRamT2];
        }
    }

    function Atualizar_Dough1() {

        Atualizar_Vetores();
        const valorRAM = VetorRamT2[0] || 0;
        ram.innerHTML = `${valorRAM}%`;
        // console.log(VetorRamT2)
    }
    setInterval(Atualizar_Dough1, 1000);


//---------------------------------------------------------------//

    function notificacao(msg) {

        let notify = document.createElement('div');
        notify.classList.add('notify');
        notify.innerHTML = msg;
        notify_box.appendChild(notify);


        setTimeout(() => {
            notify.remove();
        }, 5000);

        for (i = 0; i <= contador; i++) {
            QtdNotify++;
            QtdNotify2++;
            document.getElementById("QtdAlertas").innerHTML = `${QtdNotify}`;
            document.getElementById("QtdAlertas2").innerHTML = `${QtdNotify2}`;
            document.getElementById("QtdAlertas").style.backgroundColor = "#ffffff";
        }

    }

    function acionarAlertasENotificacao() {
        Alertas();
        // notificacao();
    }


    function alterarCorDiv() {
            const div = document.getElementById('status');
            const texto = div.textContent.trim(); 
            
            let cor;
            switch (texto) {
                case 'Normal':
                    cor = 'green';
                    break;
                case 'Alerta':
                    cor = '#b3b012';
                    div.style.color = 'white'; 
                    break;
                case 'Crítico':
                    cor = 'red';
                    break;
                default:
                    cor = 'gray';
            }

            div.style.backgroundColor = cor;
        }
        setInterval(alterarCorDiv, 1000);


        function alterarCorDiv() {
        const status = document.getElementById('status');
        const ram = document.getElementById('ram');
        const recomendado = document.getElementById('recomendado');
        const texto = status.textContent.trim();


        // Ta mudando a cor da div misera, vambora //
        if (VetorRamT2[VetorRamT2.length - 1] >= 90) {
            status.textContent = "Crítico"
            console.log("chegou aqui")
        }
        else if (VetorRamT2[VetorRamT2.length - 1] >= 75 &&
            VetorRamT2[VetorRamT2.length - 1] < 90) {
            status.textContent = "Alerta"
        }
        else {
            status.textContent = "Normal"
        }


        if (VetorRamT2[VetorRamT2.length - 1] >= 90) {
            ram.style.backgroundColor = "#990000"
        }
        else if (VetorRamT2[VetorRamT2.length - 1] < 90 &&
                    VetorRamT2[VetorRamT2.length - 1] >= 80) {
            ram.style.backgroundColor = "#FF8C00"
        }
        else if (VetorRamT2[VetorRamT2.length - 1] < 80 &&
                    VetorRamT2[VetorRamT2.length - 1] >= 65) {
            ram.style.backgroundColor = "#FFD700"
        }
        else if (VetorRamT2[VetorRamT2.length - 1] < 65 &&
                    VetorRamT2[VetorRamT2.length - 1] >= 50) {
            ram.style.backgroundColor = "#bdeb00"
        }
        else if (VetorRamT2[VetorRamT2.length - 1] < 50 &&
                    VetorRamT2[VetorRamT2.length - 1] >= 40) {
            ram.style.backgroundColor = "#7CFC00"
        }
        else{
            ram.style.backgroundColor = "#27e600"
        }


        let cor;
        switch (texto) {
            case 'Normal':
                cor = '#089900';
                break;
            case 'Alerta':
                cor = '#FFCF00';
                status.style.color = 'white';
                break;
            case 'Crítico':
                cor = '#990000';
                break;
            default:
                cor = 'gray';
        }

        status.style.backgroundColor = cor;
    }
    setInterval(alterarCorDiv, 1000);

</script>