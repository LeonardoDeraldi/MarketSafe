<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/dashboards/dash_previsao_gerente.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>MarketSafe | Dashboard - Previsão</title>
  </head>

  <body>
    <div>
      <header>
        <div class="logo">
          <div class="img">
            <img src="../assets/logo.png" alt="logo" />
          </div>
          <h1>MKTS</h1>
        </div>
        <nav>
          <h1>Dashboards</h1>
          <section class="gerente">
            <h2>Gerente</h2>
            <ul>
              <li>
                <a href="dash_previsao_gerente.html"> 
                  <h2>Previsão</h2>
                  <img src="../assets/previsao.svg" alt="previsao.svg" />
                </a>
              </li>
              <li>
                <a href="/dash_individual_Gisele.html">
                  <h2>Histórico</h2>
                  <img src="../assets/historico.svg" alt="historico.svg" />
                </a>
              </li>
              <li>
                <a href="/dashboards/dashboardBenchmarkGerente.html">
                  <h2>Benchmark</h2>
                  <img src="../assets/benchmark.svg" alt="previsao.svg" />
                </a>
              </li>
            </ul>
          </section>
          <section class="analista">
            <h2>Analista</h2>
            <ul>
              <li>
                <a href="/dash_individual_Isaque_Principal.html">
                  <h2>Monitoramento</h2>
                  <img src="../assets/monitoramento.svg" alt="monitoramento.svg" />
                </a>
              </li>
              <li>
                <a href="../dash_historico_analista.html">
                  <h2>Histórico</h2>
                  <img src="../assets/historico.svg" alt="historico.svg" />
                </a>
              </li>
              <li>
                <a href="/dashboards/dash_individual_benchmark.html">
                  <h2>Benchmark</h2>
                  <img src="../assets/benchmark.svg" alt="previsao.svg" />
                </a>
              </li>
            </ul>
          </section>
        </nav>
        <hr />
        <a class="perfil" href="/perfilGerente.html">
          <div class="img">
            <img src="../assets/perfil.svg" alt="perfil.svg" />
          </div>
          <div>
            <span class="nome">Vitor</span>
            <hr />
            <span>Gerente</span>
          </div>
        </a>
      </header>
      <main>
        <header>
          <div>
            <h1>Previsão</h1>
          </div>
          <search>
            <label>
              <span>Filial</span>
              <div>
                <select class="filial" id="selectFilial">
                  <option value="" selected disabled>Filial</option>
                  <option value="1">Filial 1</option>
                  <option value="2">Filial 2</option>
                  <option value="3">Filial 3</option>
                </select>
              </div>
            </label>
            <label>
              <span>Período</span>
              <div>
                <span>de:</span>
                <input type="date" id="periodoInicio">
                <span>até:</span>
                <input type="date" id="periodoFim">
              </div>
            </label>
            <label>
              <span>Promoção</span>
              <div>
                <select class="promocao">
                  <option value="" selected disabled>Promoção</option>
                </select>
              </div>
            </label>
          </search>
        </header>
        <section class="dashboard">
          <button onclick="puxarDados()">Teste function</button>
            <div class="dashCima">
              <div class="contentDash">
                <div class="dashMain">
              <canvas id="graficoBubble" style="height: 100%; width: 100%;">

              </canvas>
            </div>
          </div>
          <div class="space"></div>
          <div class="contentDash">
            <div class="dashMain">
              <canvas id="graficoLinha">

              </canvas>
            </div>
          </div>
        </div>
          <div class="dashBaixo">
            <!-- Vai se tornar o chart do webcrawler -->
            <div class="contentDash">
              <div class="dashMain">
                <canvas id="graficoBarra">
  
                </canvas>
              </div>
            </div>
            <div class="space"></div>
            <div class="ranking">
              <table>
                  <tr class="tableHeader">
                      <th>Ranking</th>
                      <th>Filial</th>
                      <th>Promoções</th>
                      <th>Taxa de sobrecarga</th>
                  </tr>
                  <tr>
                      <td class="tableSelector">1</td>
                      <td class="tableSelector">Filial 5</td>
                      <td class="tableSelector">Carnes</td>
                      <td class="tableSelector">20%</td>
                  </tr>
                  <tr>
                      <td class="tableSelector">2</td>
                      <td class="tableSelector">Filial 1</td>
                      <td class="tableSelector">Frutas</td>
                      <td class="tableSelector">13%</td>
                  </tr>
                  <tr>
                      <td class="tableSelector">3</td>
                      <td class="tableSelector">Filial 7</td>
                      <td class="tableSelector">Vegetais</td>
                      <td class="tableSelector">7%</td>
                  </tr>
              </table>
        </div>
        </section>
      </main>
    </div>
  </body>
</html>
<script>
  var idFilial = selectFilial.value;

  function puxarDados() {
    fetch(`../../previsaoGerenteRouter/puxarDados/${idFilial}`, {
      method: "GET"
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO puxarDados()!")

      if (resposta.ok) {
        console.log(resposta);
        resposta.json.then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
        })

      } else {
        console.error('Nenhum dado encontrado na API');
      }

    }).catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`)
    });
  };

  const dataBubble = {
    datasets: [{
      label: 'Atual',
      data: [{
        x: 1,
        y: 5,
        r: 10,
        label: 'Carne'
      }, {
        x: 3,
        y: 15,
        r: 15,
        label: 'Carne'
      }, {
        x: 5,
        y: 20,
        r: 20,
        label: 'Carne'
      }],
      backgroundColor: 'rgba(255, 145, 77, 0.8)'
    }, {
      label: 'Previsto',
      data: [{
        x: 7,
        y: 30,
        r: 25,
        label: 'Carne'
      }],
      backgroundColor: 'rgba(255, 49, 49, 0.8)'
    }]
  };

  const configBubble = {
    type: 'bubble',
    data: dataBubble,
    options: {
      scales: {
        y: {
          ticks: {
            color: "white"
          },
          grid: {
            color: "#9A9A9A"
          },
          // TO-DO: conseguir mudar o tamanho dos gráficos antes de implementar esse texto
          // title: {
          //   display: true,
          //   text: "Porcentagem de sobrecarga",
          //   color: "white"
          // }
        },
        x: {
          ticks: {
            color: "white"
          },
          grid: {
            color: "#9A9A9A"
          },
          title: {
            display: true,
            text: "Dias do mês",
            color: "white"
          },
        }
      },
      plugins: {
        legend: {
          labels: {
            color: "white"
          }
        },
        
        // TO-DO: conseguir mudar o tamanho dos gráficos antes de implementar esse texto
        //   display: true,
        //   text: "Previsão de taxa de alertas da Filial 5 em relação a promoções",
        //   color: "white"
        // }
      },
      responsive: true
    }
  };

  let bubbleChart = new Chart(
    document.getElementById('graficoBubble').getContext('2d'),
    configBubble
  );

  Chart.register({
    id: 'permanentLabel',
    afterDatasetsDraw: (chart, args, options) => {
      const ctx = chart.ctx;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = 'white';
      
      chart.data.datasets.forEach((dataset, i) => {
        const meta = chart.getDatasetMeta(i);
        if (meta.type !== 'bubble') return;
        
        meta.data.forEach((element, index) => {
          const item = dataset.data[index];
          const position = element.tooltipPosition();
          ctx.fillText(item.label.toString(), position.x, position.y);
        });
      });
    }
  });

  // Eu fiz uma solução temporária.. não sei se vou mudar futuramente.
  const dataLine = {
    labels: ['0', '5', '10', '15', '20', '25', '30'],
    datasets: [{
      label: 'Atual',
      data: [20, 15, 23.5, 10],
      borderColor: 'rgba(255, 145, 77)',
      backgroundColor: 'rgba(255, 145, 77)',
      pointRadius: 0
    }, {
      label: 'Previsto',
      data: [20, 15, 23.5, 10, 25, 30, 15],
      borderColor: 'rgba(255, 49, 49)',
      backgroundColor: 'rgba(255, 49, 49)',
      borderDash: [5, 5],
      pointRadius: 0
    }]
  };

  const configLine = {
    type: 'line',
    data: dataLine,
    options: {
      scales: {
        y: {
          ticks: {
            color: "white"
          },
          grid: {
            color: "#9A9A9A"
          },
          title: {
            display: true,
            text: "Quantidade de alertas",
            color: "white"
          }
        },
        x: {
          ticks: {
            color: "white"
          },
          grid: {
            display: false
          },
          title: {
            display: true,
            text: "Dias do mês",
            color: "white"
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: "white"
          }
        },
        title: {
          display: true,
          text: "Previsão de quantidade de alertas da Filial IDAQUI deste mês",
          color: "white"
        }
      },
      responsive: true
    }
  };

  let lineChart = new Chart(
    document.getElementById('graficoLinha').getContext('2d'),
    configLine
  );

  // Vai se tornar o chart do webcrawler
  const dataBar = {
    labels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
    datasets: [{
      label: '',
      data: [5, 10, 15, 20, 25],
      backgroundColor: [
        'rgba(255, 145, 77)',
        'rgba(255, 145, 77)',
        'rgba(255, 145, 77)',
        'rgba(255, 145, 77)',
        'rgba(255, 49, 49)',
      ]
    }]
  };

  const configBar = {
    type: 'bar',
    data: dataBar,
    options: {
      scales: {
        y: {
          ticks: {
            color: "white"
          },
          grid: {
            color: "#9A9A9A"
          }
        },
        x: {
          ticks: {
            color: "white"
          },
          grid: {
            display: false
          },
          title: {
            display: true,
            text: "Meses",
            color: "white"
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            color: "white"
          }
        }
      },
      responsive: true
    }
  };

  let barChart = new Chart(
    document.getElementById('graficoBarra').getContext('2d'),
    configBar
  );
</script>