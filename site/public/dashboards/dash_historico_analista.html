<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MarketSafe | Dashboard</title>
    <link rel="stylesheet" href="../css/dash_historico_analista.css" />
    <link rel="icon" href="css/icon.png" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
    <div class="container">
        <div class="menu">
            <div class="div_logo">
                <img src="../assets/logo.png" alt="">
                <div class="MKTS">
                    <h1>MKTS</h1>
                </div>
            </div>
            <div class="select_dash">
                <h2>Dashboards</h2>
            </div>
            <div class="regiao-select">
                <div class="analista">
                    <h3>Analista</h3>
                </div>
                <div class="monitoramento">
                    <p>Monitoramento</p> <i class='bx bx-show'></i>
                </div>
                <div class="monitoramento">
                    <p>Histórico</p> <i class='bx bx-file-blank'></i>
                </div>
                <div class="monitoramento">
                    <p>BenchMark</p> <i class="fa-solid fa-scale-balanced"></i>
                </div>
            </div>
            <div class="linha">
            </div>
            <div class="perfil">
                <div class="foto_perfil">
                    <img src="../css/foto-anilista.jpg" alt="">
                </div>
                <div class="nome_perfil">
                    <div class="nome">
                        <h2>Fred</h2>
                    </div>
                    <hr>
                    <div class="cargo">
                        <p>Analista</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashes">
            <div class="titulo">
                <h1>Dashboard Histórico</h1>
            </div>
            <div class="filtros">
                <div class="periodo">
                    <h2>Escolha um periodo para analisar</h2>
                    <div class="select_periodo">
                        <select name="ano" id="select_mes">
                            <option selected value="">MÊS</option>
                        </select>
                        <select name="ano" id="select_dia">
                            <option selected value="">DIAS</option>
                        </select>
                    </div>
                </div>
                <div class="componente">
                    <h2>Escolha um componente para analisar</h2>
                    <div class="select_periodo">
                        <select name="ano">
                            <option selected value="">CPU</option>
                            <option value="">RAM</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="linha_grafico2">
                <div class="grafico4">
                    <div class="media">
                        <div class="texto">
                            <p>Horário com maior número de alertas</p>
                        </div>
                        <div class="hora">
                            <p></p>
                        </div>
                    </div>
                    <div class="media">
                        <div class="texto">
                            <p>Média de horário com mais movimento</p>
                        </div>
                        <div class="hora">
                            <p></p>
                        </div>
                    </div>
                    <div class="media">
                        <div class="texto">
                            <p>Média de horário com mais movimento</p>
                        </div>
                        <div class="hora">
                            <p></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="graficos_dashes">
                <div class="linha_grafico1">
                    <h3>Totens com mais alertas da semana</h3>
                    <div id="rank" class="grafico1"></div>
                </div>
                <div class="selecionar_grafico">
                    <div class="titulo_graficoSelecionar">
                        <h3>Taxa de totem em alerta por dia</h3>
                        <select name="ano" id="select_grafico" onchange="alterarGrafico()">
                            <option selected value="0">TAXA</option>
                            <option value="1">TOTAL</option>
                        </select>
                    </div>
                    <div class="graficos_selecionados">
                        <div id="taxa" class="grafico2" style="display: block;"></div>
                        <div id="total" class="grafico3" style="display: none;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div>
    </div>
</body>

</html>

<script>

    function alterarGrafico() {
        var selectTaxa = select_grafico.value;

        const grafico2 = document.getElementsByClassName('grafico2')[0];
        const grafico3 = document.getElementsByClassName('grafico3')[0];

        grafico2.style.display = "none";
        grafico3.style.display = "none";

        if (selectTaxa == 0) {
            grafico2.style.display = "block"
            cadastrarTaxa()
        } else if (selectTaxa == 1) {
            grafico3.style.display = "block"
            cadastrarHora()
        }
    }

    cadastrarMes();
    function cadastrarMes() {
        fetch("/historicoLeo/cadastrarMes", {
            method: "GET",
        })
            .then(function (resposta) {
                console.log(resposta)
                return resposta.json();
            })
            .then(function (meses) {
                console.log(meses)
                var select_mes = document.getElementById('select_mes');
                meses.forEach((mes) => {
                    select_mes.innerHTML += `<option value="${mes.mes}">${mes.mes}</option>`;
                    atualizarRankingDia()
                });
            })
            .catch(function (erro) {
                alert(erro);
                console.log("Erro ao carregar linhas:", erro);
            });
    }


    function cadastrarDia() {
        fetch("/historicoLeo/cadastrarDia", {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dias) {
                var select_dia = document.getElementById('select_dia');
                dias.forEach((dia) => {
                    select_dia.innerHTML += `<option value="${dia.id}">${dia.intervalo_dias}</option>`;
                });
            })
            .catch(function (erro) {
                alert(erro);
                console.log("Erro ao carregar linhas:", erro);
            });
    }

    cadastrarDia();

    function cadastrarRanking(ranking) {
        const totem = ranking.map(item => item.totem)
        const idTotem = ranking.map(item => item.idTotem)
        const total_alertas = ranking.map(item => item.total_alertas)
        console.log(total_alertas)
        var options = {
            series: [{
                name: "Total de alertas do totem",
                data: total_alertas,
            }],
            chart: {
                type: 'bar',
                height: 300,
                width: 600,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    borderRadiusApplication: 'end',
                    horizontal: true,
                    colors: {
                        ranges: [{
                            from: 0,
                            to: 100,
                            color: '#FF8818' // Cor das barras
                        }]
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            xaxis: {
                min: 0,
                max: 100,
                categories: idTotem,
                title: {
                    text: 'Número de alertas por totem',
                    fontFamily: 'Abel',
                    style: {
                        color: '#ffffff'
                    }
                },
                labels: {
                    style: {
                        colors: "#FFFFFF",
                        fontFamily: "Abel"
                    }
                }
            },
            yaxis: {
                formatter: function (value) {
                    return value;
                },
                labels: {
                    style: {
                        colors: "#ffffff"
                    }
                }
            },
            tooltip: {
                theme: 'dark',  // Define o tema escuro para o tooltip
                style: {
                    fontFamily: 'Abel',
                    fontSize: '14px',
                    color: '#fff'
                },
                marker: {
                    show: false
                }
            }
        };

        if (!window.chartGRAFICO) {
            window.chartGRAFICO = new ApexCharts(document.querySelector("#rank"), options);
            window.chartGRAFICO.render();
        } else {
            window.chartGRAFICO.updateOptions(options);
        }
    }

    function buscarDadosRanking() {
        fetch("/historicoLeo/cadastrarRanking", {
            method: "GET"
        })
            .then(resposta => resposta.json())
            .then(ranking => {
                console.log(ranking)
                cadastrarRanking(ranking);
            }
            )
    }
    buscarDadosRanking()

    function cadastrarTaxa(taxa) {
        const dia = taxa.map(item => item.dia);
        const taxa_porcentagem = taxa.map(item => item.taxa_porcentagem);

        // Configuração do gráfico
        var options = {
            series: [{
                name: "Percentual total",
                data: taxa_porcentagem
            }],
            chart: {
                height: 290,
                width: 700,
                type: 'line',
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight',
                colors: ['#FF8818']
            },
            grid: {
                row: {
                    colors: ['transparent', 'transparent'],
                    opacity: 0.5
                },
            },
            xaxis: {
                categories: dia,
                labels: {
                    style: {
                        colors: "#ffffff",
                        fontFamily: "Abel"
                    },
                    formatter: function (value) {
                        const date = new Date(value);
                        if (isNaN(date.getTime())) return value;
                        return ('0' + date.getDate()).slice(-2) + '/' + ('0' + (date.getMonth() + 1)).slice(-2);
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Taxa de alerta do total de totens',
                    align: 'center',
                    style: {
                        color: '#ffffff',
                        fontFamily: 'Abel'
                    }
                },
                labels: {
                    style: {
                        colors: "#ffffff",
                        fontFamily: "Abel"
                    },
                    formatter: function (value) {
                        return value + "%";
                    },
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontFamily: 'Abel',
                    fontSize: '14px',
                    color: '#fff'
                },
                marker: {
                    show: false
                },
                x: {
                    formatter: function (value) {
                        const date = new Date(value);
                        if (isNaN(date.getTime())) return value;
                        return ('0' + date.getDate()).slice(-2) + '/' + ('0' + (date.getMonth() + 1)).slice(-2);
                    }
                },
                y: {
                    formatter: function (value) {
                        return value + '%';
                    }
                }
            }
        };

        // Inicializa ou atualiza o gráfico
        if (!window.chartTAXA) {
            const chartElement = document.querySelector("#taxa");
            if (!chartElement) {
                console.error("Elemento '#taxa' não encontrado no DOM.");
                return;
            }
            window.chartTAXA = new ApexCharts(chartElement, options);
            window.chartTAXA.render();
        } else {
            window.chartTAXA.updateOptions(options).catch(err => {
                console.error("Erro ao atualizar o gráfico:", err);
            });
        }
    }
    function buscarDadosTaxa() {
        fetch("/historicoLeo/cadastrarTaxa", {
            method: "GET"
        })
            .then(resposta => resposta.json())
            .then(taxa => {
                console.log(taxa)
                cadastrarTaxa(taxa);
            }
            )
    }
    buscarDadosTaxa()

    function cadastrarHora(especifico) {
        especifico.sort((a, b) => new Date(a.hora) - new Date(b.hora));
        const horaMomento = especifico.map(item => {
            const hora = new Date(item.hora);
            hora.setHours(hora.getHours());
            return hora.toISOString();
        });

        console.log(hora)
        console.log(horaMomento)
        const total_alertas = especifico.map(item => item.total_alertas)

        var options = {
            series: [{
                name: 'Total de alertas por hora',
                data: total_alertas
            }],
            title: {
                text: 'Total de alertas por hora',
                align: 'center',
                style: {
                    color: '#ffffff',
                    fontFamily: 'Abel',
                    fontSize: '20px'
                }
            },
            chart: {
                type: 'bar',
                height: 290,
                width: 700,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                labels: {
                    style: {
                        colors: '#ffffff',
                        fontFamily: 'Abel'
                    },
                    formatter: function (value) {
                        var hour = value < 10 ? '0' + value : value;
                        return hour + ':00';
                    }
                },
                categories: horaMomento
            },
            yaxis: {
                labels: {
                    style: {
                        colors: '#ffffff',
                        fontFamily: 'Abel'
                    }
                }
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                theme: 'dark',
                y: {
                    formatter: function (val) {
                        return val;
                    }
                },
                x: {
                    formatter: function (value) {
                        var hour = value < 10 ? '0' + value : value;
                        return hour + ':00';
                    }
                },
                style: {
                    fontFamily: 'Abel',
                    fontSize: '14px',
                    color: '#fff'
                },
                marker: {
                    show: false
                }
            }
        };

        if (!window.chartHORA) {
            window.chartHORA = new ApexCharts(document.querySelector("#total"), options);
            window.chartHORA.render();
        } else {
            window.chartHORA.updateOptions(options);
        }
    }

    const buscarDadosHora = () => {
        fetch("/historicoLeo/cadastrarHora", {
            method: "GET"
        })
            .then(resposta => resposta.json())
            .then(especifico => {
                console.log(especifico)
                cadastrarHora(especifico)
            }
            )
    };
    buscarDadosHora();
    setInterval(buscarDadosHora, 2000);


    select_mes.addEventListener("change", atualizarRankingDia);
    select_dia.addEventListener("change", atualizarRankingDia);

    function atualizarRankingDia() {
        var selectMes = document.getElementById("select_mes");
        var selectDia = document.getElementById("select_dia");

        var mes = Number(selectMes.value);
        var dia = Number(selectDia.value);
        console.log("Mês selecionado: ", mes);
        console.log("Dia selecionado: ", dia);

        fetch(`/historicoLeo/atualizarMesRanking?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (ranking) {
                console.log(ranking)
                cadastrarRanking(ranking)
            })
            .catch(function (erro) {
                alert(erro);
                console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarMesTaxa?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (taxa) {
                console.log(taxa)
                cadastrarTaxa(taxa)
            })
            .catch(function (erro) {
                alert(erro);
                console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarMesEspecifico?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (especifico) {
                console.log(especifico)

            })
            .catch(function (erro) {
                alert(erro);
                console.log("Erro ao carregar linhas:", erro);
            });
    }



</script>