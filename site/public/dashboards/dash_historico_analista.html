<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MarketSafe | Dashboard</title>
    <link rel="stylesheet" href="../css/dash_historico_analista.css" />
    <link rel="icon" href="css/icon.png" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="carregarBody()">
    <div class="container">
        <div class="menu">
            <div class="div_logo">
                <img src="../assets/logo.png" alt="">
                <div class="MKTS">
                    <h1>MKTS</h1>
                </div>
            </div>
            <div class="select_dash">
                <h2>Dashboards</h2>
            </div>
            <div class="regiao-select">
                <div class="analista">
                    <h3>Analista</h3>
                </div>
                <div class="monitoramento">
                    <p>Monitoramento</p> <i class='bx bx-show'></i>
                </div>
                <div class="monitoramento">
                    <p>Histórico</p> <i class='bx bx-file-blank'></i>
                </div>
                <div class="monitoramento">
                    <p>BenchMark</p> <i class="fa-solid fa-scale-balanced"></i>
                </div>
            </div>
            <div class="linha">
            </div>
            <div class="perfil">
                <div class="foto_perfil">
                    <img src="../css/foto-anilista.jpg" alt="">
                </div>
                <div class="nome_perfil">
                    <div class="nome">
                        <h2>Fred</h2>
                    </div>
                    <hr>
                    <div class="cargo">
                        <p>Analista</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashes">
            <div class="titulo">
                <h1>Dashboard Histórico</h1>
            </div>
            <div class="filtros">
                <div class="periodo">
                    <h2>Escolha um periodo para analisar</h2>
                    <div class="select_periodo">
                        <select name="ano" id="select_mes">
                            <option selected value="">MÊS</option>
                        </select>
                        <select name="ano" id="select_inicio">
                            <option selected value="">DIA INICIO</option>
                        </select>
                        <select name="ano" id="select_fim">
                            <option selected value="">DIA FIM</option>
                        </select>
                    </div>
                </div>
                <div class="componente">
                    <h2>Escolha um componente para analisar</h2>
                    <div class="select_periodo">
                        <select name="ano">
                            <option selected value="">CPU</option>
                            <option value="">RAM</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="linha_grafico2">
                <div class="grafico4">
                    <div class="media">
                        <div class="texto">
                            <p>Horário com maior número de alertas</p>
                        </div>
                        <div class="hora">
                            <p id="MaisAlerta"></p>
                        </div>
                    </div>
                    <div class="media">
                        <div class="texto">
                            <p>Dia da semana com mais alertas</p>
                        </div>
                        <div class="hora">
                            <p id="AlertaSemana"></p>
                        </div>
                    </div>
                    <div class="media">
                        <div class="texto">
                            <p>Média de horário com mais movimento</p>
                        </div>
                        <div class="hora">
                            <p id="MediaHorario"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="graficos_dashes">
                <div class="linha_grafico1">
                    <h3>Totens com mais alertas da semana</h3>
                    <div id="rank" class="grafico1"></div>
                </div>
                <div class="selecionar_grafico">
                    <div class="titulo_graficoSelecionar">
                        <h3>Taxa de totem em alerta por dia</h3>
                        <select name="ano" id="select_grafico" onchange="alterarGrafico()">
                            <option selected value="0">TAXA</option>
                            <option value="1">TOTAL</option>
                        </select>
                    </div>
                    <div class="graficos_selecionados">
                        <div id="taxa" class="grafico2" style="display: block;"></div>
                        <div id="total" class="grafico3" style="display: none;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div>
    </div>
</body>

</html>

<script>

function alterarGrafico() {
        var selectTaxa = select_grafico.value;

        const grafico2 = document.getElementsByClassName('grafico2')[0];
        const grafico3 = document.getElementsByClassName('grafico3')[0];

        grafico2.style.display = "none";
        grafico3.style.display = "none";

        if (selectTaxa == 0) {
            grafico2.style.display = "block"
            cadastrarTaxa()
        } else if (selectTaxa == 1) {
            grafico3.style.display = "block"
            buscarDadosHora();
        }
    }

    function carregarBody(){
    cadastrarMes();
    async function cadastrarMes() {
        const resposta = await fetch("/historicoLeo/cadastrarMes", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then(function (resposta) {
            // console.log(resposta.headers)
            return resposta.json();
        })
        .then(function (meses) {
            console.log(meses)
            var select_mes = document.getElementById('select_mes');
            meses.forEach((mes) => {
                select_mes.innerHTML += `<option value="${mes.mes}">${mes.mes}</option>`;
            });
            // atualizarRankingDia()
        })
        .catch(function (erro) {
            alert(erro);
            console.log("Erro ao carregar linhas:", erro);
        });
    }

    function cadastrarDiaInicio() {
        fetch("/historicoLeo/cadastrarDiaInicio", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dias) {
                var select_inicio = document.getElementById('select_inicio');
                dias.forEach((dia) => {
                    select_inicio.innerHTML += `<option value="${dia.dia_alerta}">${dia.dia_alerta}</option>`;
                });
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });
    }

    cadastrarDiaFim();

    function cadastrarDiaFim() {
        fetch("/historicoLeo/cadastrarDiaFim", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (dias) {
                var select_fim = document.getElementById('select_fim');
                dias.forEach((dia) => {
                    select_fim.innerHTML += `<option value="${dia.dia_alerta}">${dia.dia_alerta}</option>`;
                });
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });
    }

    cadastrarDiaFim();

    function cadastrarRanking(ranking) {
        const totem = ranking.map(item => item.totem)
        const idTotem = ranking.map(item => item.idTotem)
        const total_alertas = ranking.map(item => item.total_alertas)
        //console.log(total_alertas)
        var options = {
            series: [{
                name: "Total de alertas do totem",
                data: total_alertas,
            }],
            chart: {
                type: 'bar',
                height: 300,
                width: 600,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    borderRadiusApplication: 'end',
                    horizontal: true,
                    colors: {
                        ranges: [{
                            from: 0,
                            to: 100,
                            color: '#FF8818' // Cor das barras
                        }]
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            xaxis: {
                min: 0,
                max: 100,
                categories: idTotem,
                title: {
                    text: 'Número de alertas por totem',
                    fontFamily: 'Abel',
                    style: {
                        color: '#ffffff'
                    }
                },
                labels: {
                    style: {
                        colors: "#FFFFFF",
                        fontFamily: "Abel"
                    }
                }
            },
            yaxis: {
                formatter: function (value) {
                    return value;
                },
                labels: {
                    style: {
                        colors: "#ffffff"
                    }
                }
            },
            tooltip: {
                theme: 'dark',  // Define o tema escuro para o tooltip
                style: {
                    fontFamily: 'Abel',
                    fontSize: '14px',
                    color: '#fff'
                },
                marker: {
                    show: false
                }
            }
        };

        if (!window.chartGRAFICO) {
            window.chartGRAFICO = new ApexCharts(document.querySelector("#rank"), options);
            window.chartGRAFICO.render();
        } else {
            window.chartGRAFICO.updateOptions(options);
        }
    }

    function buscarDadosRanking() {
        fetch("/historicoLeo/cadastrarRanking", {
            method: "GET"
        })
            .then(resposta => resposta.json())
            .then(ranking => {
                //console.log(ranking)
                cadastrarRanking(ranking);
            }
            )
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });
    }
    buscarDadosRanking()

    function cadastrarTaxa(taxa) {
        console.log(taxa)
        const dia = taxa.map(item => item.dia);
        const taxa_porcentagem = taxa.map(item => item.taxa_porcentagem);

        // Configuração do gráfico
        var options = {
            series: [{
                name: "Percentual total",
                data: taxa_porcentagem
            }],
            chart: {
                height: 290,
                width: 700,
                type: 'line',
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight',
                colors: ['#FF8818']
            },
            grid: {
                row: {
                    colors: ['transparent', 'transparent'],
                    opacity: 0.5
                },
            },
            xaxis: {
                categories: dia,
                labels: {
                    style: {
                        colors: "#ffffff",
                        fontFamily: "Abel"
                    },
                    formatter: function (value) {
                        const date = new Date(value);
                        if (isNaN(date.getTime())) return value;
                        return ('0' + date.getDate()).slice(-2) + '/' + ('0' + (date.getMonth() + 1)).slice(-2);
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Taxa de alerta do total de totens',
                    align: 'center',
                    style: {
                        color: '#ffffff',
                        fontFamily: 'Abel'
                    }
                },
                labels: {
                    style: {
                        colors: "#ffffff",
                        fontFamily: "Abel"
                    },
                    formatter: function (value) {
                        return value + "%";
                    },
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontFamily: 'Abel',
                    fontSize: '14px',
                    color: '#fff'
                },
                marker: {
                    show: false
                },
                x: {
                    formatter: function (value) {
                        const date = new Date(value);
                        if (isNaN(date.getTime())) return value;
                        return ('0' + date.getDate()).slice(-2) + '/' + ('0' + (date.getMonth() + 1)).slice(-2);
                    }
                },
                y: {
                    formatter: function (value) {
                        return value + '%';
                    }
                }
            }
        };

        // Inicializa ou atualiza o gráfico
        if (!window.chartTAXA) {
            const chartElement = document.querySelector("#taxa");
            if (!chartElement) {
                console.error("Elemento '#taxa' não encontrado no DOM.");
                return;
            }
            window.chartTAXA = new ApexCharts(chartElement, options);
            window.chartTAXA.render();
        } else {
            window.chartTAXA.updateOptions(options).catch(err => {
                console.error("Erro ao atualizar o gráfico:", err);
            });
        }
    }
    function buscarDadosTaxa() {
        fetch("/historicoLeo/cadastrarTaxa", {
            method: "GET"
        })
            .then(resposta => resposta.json())
            .then(taxa => {
                console.log(taxa)
                cadastrarTaxa(taxa);
            }
            )
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });
    }
    buscarDadosTaxa()

    function cadastrarHora(especifico) {
        var hora;
        // Ordena o array com base na propriedade "hora" (numérica)
        especifico.sort((a, b) => a.hora - b.hora);
        //console.log(especifico);
        // Mapeia as horas para formato ISO
        const horaMomento = especifico.map(item => {
            hora = new Date();
            hora.setHours(item.hora);
            hora.setMinutes(0);  // Garante que os minutos sejam 0
            hora.setSeconds(0);  // Garante que os segundos sejam 0
            hora.setMilliseconds(0); // Garante que os milissegundos sejam 0
            return hora.toISOString();
        });
        //console.log(especifico);
        //console.log(hora);
        //console.log(horaMomento);

        // Extrai os valores de total_alertas para criar o gráfico
        const total_alertas = especifico.map(item => item.total_alertas);

        var options = {
            series: [{
                name: 'Total de alertas por hora',
                data: total_alertas
            }],
            title: {
                text: 'Total de alertas por hora',
                align: 'center',
                style: {
                    color: '#ffffff',
                    fontFamily: 'Abel',
                    fontSize: '20px'
                }
            },
            chart: {
                type: 'bar',
                height: 290,
                width: 700,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                labels: {
                    style: {
                        colors: '#ffffff',
                        fontFamily: 'Abel'
                    },
                    formatter: function (value) {
                        var hour = value < 10 ? '0' + value : value;
                        return hour + ':00';
                    }
                },
                categories: horaMomento
            },
            yaxis: {
                labels: {
                    style: {
                        colors: '#ffffff',
                        fontFamily: 'Abel'
                    }
                }
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                theme: 'dark',
                y: {
                    formatter: function (val) {
                        return val;
                    }
                },
                x: {
                    formatter: function (value) {
                        var hour = value < 10 ? '0' + value : value;
                        return hour + ':00';
                    }
                },
                style: {
                    fontFamily: 'Abel',
                    fontSize: '14px',
                    color: '#fff'
                },
                marker: {
                    show: false
                }
            }
        };

        if (!window.chartHORA) {
            window.chartHORA = new ApexCharts(document.querySelector("#total"), options);
            window.chartHORA.render();
        } else {
            window.chartHORA.updateOptions(options);
        }
    }

    const buscarDadosHora = () => {
        fetch("/historicoLeo/cadastrarHora", {
            method: "GET"
        })
            .then(resposta => resposta.json())
            .then(especifico => {
                //console.log('Resposta recebida:', especifico);
                cadastrarHora(especifico);
            })
            .catch(erro => {
                console.error('Erro ao buscar dados:', erro);
            });

    };
    buscarDadosHora();

    function maisAlerta(mes) {
        const MaisAlerta = document.getElementById("MaisAlerta");
        if (!MaisAlerta) {
            console.error("Elemento 'MaisAlerta' não encontrado.");
            return;
        }

        fetch(`/historicoLeo/maisAlerta`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error(`Erro na resposta: ${resposta.status}`);
                }
                return resposta.json();
            })
            .then(function (dados) {
                dados.forEach((dado) => {
                    MaisAlerta.innerHTML = `${mes[0].hora}:00`;
                });
            })
            .catch(function (erro) {
                console.error("Erro ao buscar alertas:", erro);
            });
    }


    function alertaSemana(mes) {
        const AlertaSemana = document.getElementById("AlertaSemana");
        if (!AlertaSemana) {
            console.error("Elemento 'AlertaSemana' não encontrado.");
            return;
        }

        fetch(`/historicoLeo/alertaSemana`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error(`Erro na resposta: ${resposta.status}`);
                }
                return resposta.json();
            })
            .then(function (dados) {
                dados.forEach((dado) => {
                    AlertaSemana.innerHTML = `${mes[0].dia_mes}`;
                });
            })
            .catch(function (erro) {
                console.error("Erro ao buscar alertas:", erro);
            });
    }

    function mediaHorario(mes) {
        const MediaHorario = document.getElementById("MediaHorario");
        if (!MediaHorario) {
            console.error("Elemento 'MediaHorario' não encontrado.");
            return;
        }

        fetch(`/historicoLeo/mediaHorario`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error(`Erro na resposta: ${resposta.status}`);
                }
                return resposta.json();
            })
            .then(function (dados) {
                dados.forEach((dado) => {
                    MediaHorario.innerHTML = `${mes[0].hora_alerta}:00`;
                });
            })
            .catch(function (erro) {
                console.error("Erro ao buscar alertas:", erro);
            });
    }

    function atualizarRankingDia() {
        var selectMes = document.getElementById("select_mes");
        var selectInicio = document.getElementById("select_inicio");
        var selectFim = document.getElementById("select_fim");

        var mes = Number(selectMes.value);
        var inicio = Number(selectInicio.value);
        var fim = Number(selectFim.value);

        fetch(`/historicoLeo/atualizarMesRanking?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (ranking) {
                //console.log(ranking)
                cadastrarRanking(ranking)
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarMesTaxa?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (taxa) {
                console.log(taxa)
                cadastrarTaxa(taxa)
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarMesEspecifico?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then(function (especifico) {
                //console.log(especifico)
                cadastrarHora(especifico)
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarMaisAlerta?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error(`Erro na resposta: ${resposta.status}`);
                }
                return resposta.json();
            })
            .then(function (mesAtualizado) {
                console.log("Mês atualizado:", mesAtualizado);
                maisAlerta(mesAtualizado);
                console.log(mesAtualizado)
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarAlertaSemana?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error(`Erro na resposta: ${resposta.status}`);
                }
                return resposta.json();
            })
            .then(function (mesAtualizado) {
                //console.log("Mês atualizado:", mesAtualizado);
                alertaSemana(mesAtualizado);
                //console.log(mesAtualizado)
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });

        fetch(`/historicoLeo/atualizarMediaHorario?mes=${mes}`, {
            method: "GET",
        })
            .then(function (resposta) {
                console.log(resposta.status)
                if (!resposta.ok) {
                    throw new Error(`Erro na resposta: ${resposta.status}`);
                }
                return resposta.json();
            })
            .then(function (mesAtualizado) {
                // console.log("Mês atualizado:", mesAtualizado);
                mediaHorario(mesAtualizado);
                //console.log(mes)
            })
            .catch(function (erro) {
                alert(erro);
                //console.log("Erro ao carregar linhas:", erro);
            });
    }

    select_mes.addEventListener("change", atualizarRankingDia);
}
</script>